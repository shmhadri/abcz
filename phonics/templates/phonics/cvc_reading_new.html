{% extends "letters.html" %}
{% load static %}

{% block title %}ØªØ¯Ø±ÙŠØ¨ Ù‚Ø±Ø§Ø¡Ø© CVC{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
    :root {
        --primary-color: #4a90e2;
        --secondary-color: #50e3c2;
        --success-color: #7ed321;
        --danger-color: #d0021b;
        --light-color: #f5f7fa;
        --dark-color: #4a4a4a;
        --white-color: #ffffff;
        --border-radius: 15px;
        --shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .cvc-main-container {
        max-width: 950px;
        margin: 2rem auto;
        padding: 2rem;
        background: var(--white-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        text-align: center;
        font-family: 'Cairo', sans-serif;
    }

    .cvc-header h2 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .cvc-header p {
        font-size: 1.1rem;
        color: var(--dark-color);
        margin-bottom: 2rem;
    }

    .nav-pills .nav-link {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--dark-color);
        background-color: var(--light-color);
        margin: 0 5px;
        border-radius: 50px;
        padding: 10px 25px;
        transition: all 0.3s ease;
    }

    .nav-pills .nav-link.active {
        background-color: var(--primary-color);
        color: var(--white-color);
        box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4);
    }

    .tab-content { margin-top: 2.5rem; }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .item-card {
        background: var(--light-color);
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 1.5rem;
        animation: fadeIn 0.35s ease;
    }

    .item-image {
        width: 220px;
        height: 220px;
        object-fit: cover;
        border-radius: var(--border-radius);
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
    }

    .item-text {
        font-size: 3.5rem;
        font-weight: 700;
        color: var(--dark-color);
        line-height: 1.2;
    }

    .sentence-text { font-size: 2.8rem; }

    .item-translation {
        font-size: 1.2rem;
        color: #777;
        margin-top: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .action-buttons button {
        font-size: 1.8rem;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        margin: 0 15px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .action-buttons button:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .btn-speak { background-color: var(--primary-color); color: var(--white-color); }
    .btn-mic { background-color: var(--success-color); color: var(--white-color); }
    .btn-mic.recording {
        background-color: var(--danger-color);
        animation: pulse-red 1.5s infinite;
    }

    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(208, 2, 27, 0.7); }
        70% { box-shadow: 0 0 0 25px rgba(208, 2, 27, 0); }
        100% { box-shadow: 0 0 0 0 rgba(208, 2, 27, 0); }
    }

    .nav-buttons button, #start-challenge-btn {
        font-size: 1.1rem;
        font-weight: 600;
        padding: 12px 30px;
        border-radius: 50px;
        border: 2px solid var(--primary-color);
        background: transparent;
        color: var(--primary-color);
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 1.5rem 0.5rem 0;
    }
    .nav-buttons button:hover, #start-challenge-btn:hover {
        background: var(--primary-color);
        color: var(--white-color);
    }
    .nav-buttons button:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    #start-challenge-btn {
        background: var(--primary-color);
        color: var(--white-color);
        font-size: 1.3rem;
    }

    .progress-wrapper { margin: 1rem 0; }
    .progress {
        height: 25px;
        border-radius: 50px;
        background-color: #e9ecef;
        overflow: hidden;
    }
    .progress-bar {
        background-color: var(--success-color);
        font-weight: 600;
        font-size: 1rem;
    }

    .timer-display {
        font-size: 2rem;
        font-weight: 700;
        color: var(--danger-color);
        margin-bottom: 1rem;
    }

    #feedback-area {
        margin-top: 1.5rem;
        font-size: 1.3rem;
        font-weight: 600;
        min-height: 34px;
    }
</style>

{# CSRF: Ø®ÙŠØ§Ø± 1 (Ù…Ø¶Ù…ÙˆÙ†) #}
<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

<div class="cvc-main-container">
    <div class="cvc-header">
        <h2><i class="fas fa-bullhorn"></i> ØªØ¯Ø±ÙŠØ¨ Ù†Ø·Ù‚ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ù„Ø¬Ù…Ù„</h2>
        <p>Ø·ÙˆØ± Ù…Ù‡Ø§Ø±Ø§ØªÙƒ ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ù†Ø·Ù‚ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù…ØªØ¹Ø© ÙˆØªÙØ§Ø¹Ù„ÙŠØ©!</p>
    </div>

    <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-words-tab" data-bs-toggle="pill" data-bs-target="#pills-words" type="button" role="tab">
                <i class="fas fa-image"></i> ÙƒÙ„Ù…Ø§Øª CVC
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-sentences-tab" data-bs-toggle="pill" data-bs-target="#pills-sentences" type="button" role="tab">
                <i class="fas fa-file-invoice"></i> Ø¬Ù…Ù„ CVC
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <!-- CVC Words Panel -->
        <div class="tab-pane fade show active" id="pills-words" role="tabpanel">
            <div id="words-card-container"></div>

            <div class="progress-wrapper">
                <div class="progress">
                    <div id="words-progress-bar" class="progress-bar" role="progressbar"
                         style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
            </div>

            <div class="nav-buttons">
                <button id="prev-word-btn" disabled>&larr; Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                <button id="next-word-btn" disabled>Ø§Ù„ØªØ§Ù„ÙŠ &rarr;</button>
            </div>
        </div>

        <!-- CVC Sentences Panel -->
        <div class="tab-pane fade" id="pills-sentences" role="tabpanel">
            <button id="start-challenge-btn">ğŸš€ Ø§Ø¨Ø¯Ø£ ØªØ­Ø¯ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ù…Ù„</button>

            <div id="sentences-challenge-area" style="display: none;">
                <div class="timer-display" id="sentence-timer"></div>
                <div id="sentences-card-container"></div>

                <div class="progress-wrapper">
                    <div class="progress">
                        <div id="sentences-progress-bar" class="progress-bar" role="progressbar"
                             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button id="prev-sentence-btn" disabled>&larr; Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <button id="next-sentence-btn" disabled>Ø§Ù„ØªØ§Ù„ÙŠ &rarr;</button>
                </div>
            </div>
        </div>
    </div>

    <div id="feedback-area"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const el = {
        words: {
            container: document.getElementById('words-card-container'),
            progressBar: document.getElementById('words-progress-bar'),
            prevBtn: document.getElementById('prev-word-btn'),
            nextBtn: document.getElementById('next-word-btn'),
        },
        sentences: {
            container: document.getElementById('sentences-card-container'),
            progressBar: document.getElementById('sentences-progress-bar'),
            prevBtn: document.getElementById('prev-sentence-btn'),
            nextBtn: document.getElementById('next-sentence-btn'),
            startBtn: document.getElementById('start-challenge-btn'),
            challengeArea: document.getElementById('sentences-challenge-area'),
            timer: document.getElementById('sentence-timer'),
        },
        feedback: document.getElementById('feedback-area'),
        csrfHidden: document.getElementById('csrf-token'),
    };

    // --- State ---
    const state = {
        words: [],
        sentences: [],
        currentWordIndex: 0,
        currentSentenceIndex: 0,
        mediaRecorder: null,
        audioChunks: [],
        sentenceTimerInterval: null,
        isRecording: false,
    };

    // --- Security helpers (CSRF) ---
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return '';
    }
    function getCsrfToken() {
        // Ø§Ù„Ø£ÙØ¶Ù„: input Ø§Ù„Ù…Ø®ÙÙŠ
        const fromHidden = (el.csrfHidden && el.csrfHidden.value) ? el.csrfHidden.value : '';
        return fromHidden || getCookie('csrftoken');
    }

    // --- API ---
    const api = {
        fetchJSON: async (endpoint) => {
            try {
                const res = await fetch(endpoint, { credentials: 'same-origin' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (err) {
                console.error(`Fetch failed (${endpoint}):`, err);
                el.feedback.innerHTML = `<span style="color:var(--danger-color)">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù€ API Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.</span>`;
                return null;
            }
        },
        checkPronunciation: async (audioBlob, targetText) => {
            const formData = new FormData();

            const mime = audioBlob.type || 'audio/webm';
            const ext = mime.includes('ogg') ? 'ogg' : (mime.includes('webm') ? 'webm' : 'bin');
            formData.append('audio', audioBlob, `recording.${ext}`);
            formData.append('word', targetText);

            el.feedback.innerHTML = '<i>... ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Ø·Ù‚ ...</i>';

            try {
                const res = await fetch('/api/check-cvc-pronunciation/', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                    },
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (err) {
                console.error('Pronunciation check failed:', err);
                el.feedback.textContent = 'Ø¹ÙÙˆØ§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø·Ù‚.';
                return null;
            }
        }
    };

    // --- UI ---
    const ui = {
        setNavDisabled: (type) => {
            const isWord = type === 'words';
            const list = isWord ? state.words : state.sentences;
            const idx = isWord ? state.currentWordIndex : state.currentSentenceIndex;

            const prevBtn = isWord ? el.words.prevBtn : el.sentences.prevBtn;
            const nextBtn = isWord ? el.words.nextBtn : el.sentences.nextBtn;

            prevBtn.disabled = (idx <= 0);
            nextBtn.disabled = (idx >= list.length - 1);
        },
        updateProgress: (type) => {
            const isWord = type === 'words';
            const total = isWord ? state.words.length : state.sentences.length;
            const current = isWord ? state.currentWordIndex : state.currentSentenceIndex;
            const bar = isWord ? el.words.progressBar : el.sentences.progressBar;

            if (!total) return;
            const pct = Math.round(((current + 1) / total) * 100);
            bar.style.width = `${pct}%`;
            bar.textContent = `${pct}%`;
            bar.setAttribute('aria-valuenow', pct);
        },
        showFeedback: (result) => {
            if (!result) return;

            if (result.correct) {
                const acc = (typeof result.accuracy === 'number') ? result.accuracy : null;
                el.feedback.innerHTML =
                    `<span style="color:var(--success-color)"><i class="fas fa-check-circle"></i> ${result.message}${acc !== null ? ` (Ø§Ù„Ø¯Ù‚Ø©: ${acc}%)` : ''}</span>`;
            } else {
                el.feedback.innerHTML =
                    `<span style="color:var(--danger-color)"><i class="fas fa-times-circle"></i> ${result.message}</span>`;
            }
        },
        renderCard: (type) => {
            const isWord = type === 'words';
            const idx = isWord ? state.currentWordIndex : state.currentSentenceIndex;
            const data = isWord ? state.words[idx] : state.sentences[idx];
            const container = isWord ? el.words.container : el.sentences.container;

            if (!data) {
                container.innerHTML = `<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</p>`;
                return;
            }

            const text = isWord ? (data.word || '') : (data.sentence || '');
            const ar = isWord ? (data.arabic_meaning || '') : (data.arabic_translation || '');
            const img = data.image_url || 'https://via.placeholder.com/220';

            container.innerHTML = `
                <div class="item-card" data-id="${data.id || ''}">
                    ${isWord ? `<img src="${img}" alt="${text}" class="item-image">` : ''}
                    <div class="item-text ${isWord ? '' : 'sentence-text'}">${text}</div>
                    <div class="item-translation">${ar}</div>
                    <div class="action-buttons">
                        <button class="btn-speak" type="button" title="Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ù†Ø·Ù‚ Ø§Ù„ØµØ­ÙŠØ­">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <button class="btn-mic" type="button" title="Ø³Ø¬Ù„ Ù†Ø·Ù‚Ùƒ">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
            `;

            // bind events safely via querySelector within the new card
            const speakBtn = container.querySelector('.btn-speak');
            const micBtn = container.querySelector('.btn-mic');

            speakBtn.addEventListener('click', () => helpers.speak(text));
            micBtn.addEventListener('click', () => handlers.toggleRecord(micBtn, text, type));

            ui.updateProgress(type);
            ui.setNavDisabled(type);
        },
        startSentenceTimer: (durationSec) => {
            clearInterval(state.sentenceTimerInterval);
            let timeLeft = durationSec;

            el.sentences.timer.textContent = `â³ ${timeLeft} Ø«Ø§Ù†ÙŠØ©`;
            state.sentenceTimerInterval = setInterval(() => {
                timeLeft--;
                el.sentences.timer.textContent = `â³ ${timeLeft} Ø«Ø§Ù†ÙŠØ©`;

                if (timeLeft <= 0) {
                    clearInterval(state.sentenceTimerInterval);
                    el.sentences.timer.textContent = "â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!";

                    // auto next
                    if (state.currentSentenceIndex < state.sentences.length - 1) {
                        setTimeout(() => {
                            state.currentSentenceIndex++;
                            ui.renderCard('sentences');
                            ui.startSentenceTimer(durationSec);
                        }, 900);
                    }
                }
            }, 1000);
        }
    };

    // --- Helpers ---
    const helpers = {
        speak: (text) => {
            if (!text) return;
            if (!('speechSynthesis' in window)) {
                el.feedback.textContent = 'Ù…ÙŠØ²Ø© Ø§Ù„Ù†Ø·Ù‚ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.';
                return;
            }
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            u.rate = 0.9;
            speechSynthesis.speak(u);
        },
        goNextIfCorrect: (type) => {
            const isWord = type === 'words';
            const list = isWord ? state.words : state.sentences;
            const key = isWord ? 'currentWordIndex' : 'currentSentenceIndex';

            if (state[key] < list.length - 1) {
                state[key]++;
                ui.renderCard(type);
            }
        }
    };

    // --- Handlers ---
    const handlers = {
        navigate: (type, dir) => {
            const isWord = type === 'words';
            const list = isWord ? state.words : state.sentences;
            const key = isWord ? 'currentWordIndex' : 'currentSentenceIndex';

            state[key] = Math.min(Math.max(state[key] + dir, 0), Math.max(list.length - 1, 0));
            ui.renderCard(type);
        },

        toggleRecord: async (micBtn, targetText, type) => {
            // stop
            if (state.mediaRecorder && state.isRecording) {
                state.mediaRecorder.stop();
                return;
            }

            // start
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                el.feedback.textContent = "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† (Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù…).";
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.audioChunks = [];

                const recorder = new MediaRecorder(stream);
                state.mediaRecorder = recorder;
                state.isRecording = true;

                micBtn.classList.add('recording');
                micBtn.innerHTML = '<i class="fas fa-stop"></i>';

                recorder.addEventListener('dataavailable', (e) => {
                    if (e.data && e.data.size > 0) state.audioChunks.push(e.data);
                });

                recorder.addEventListener('stop', async () => {
                    state.isRecording = false;

                    micBtn.classList.remove('recording');
                    micBtn.innerHTML = '<i class="fas fa-microphone"></i>';

                    const mime = recorder.mimeType || 'audio/webm';
                    const audioBlob = new Blob(state.audioChunks, { type: mime });

                    // stop tracks for privacy + performance
                    stream.getTracks().forEach(t => t.stop());

                    const result = await api.checkPronunciation(audioBlob, targetText);
                    ui.showFeedback(result);

                    if (result && result.correct) {
                        setTimeout(() => helpers.goNextIfCorrect(type), 1200);
                    }
                });

                recorder.start();
            } catch (err) {
                console.error("Error getting user media:", err);
                el.feedback.textContent = "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„.";
            }
        },

        startChallenge: async () => {
            el.sentences.startBtn.style.display = 'none';
            el.sentences.challengeArea.style.display = 'block';
            el.feedback.textContent = '';

            const data = await api.fetchJSON('/api/cvc-sentences/');
            if (data && Array.isArray(data.sentences)) {
                state.sentences = data.sentences;

                if (state.sentences.length > 0) {
                    state.currentSentenceIndex = 0;
                    ui.renderCard('sentences');
                    // Ù…Ø¤Ù‚Øª Ù„ÙƒÙ„ Ø¬Ù…Ù„Ø© (ØªÙ‚Ø¯Ø± ØªØºÙŠØ±Ù‡)
                    ui.startSentenceTimer(20);
                } else {
                    el.sentences.container.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù…Ù„ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
                }
            }
        }
    };

    // --- Init ---
    (async function init() {
        el.words.prevBtn.addEventListener('click', () => handlers.navigate('words', -1));
        el.words.nextBtn.addEventListener('click', () => handlers.navigate('words', 1));
        el.sentences.prevBtn.addEventListener('click', () => handlers.navigate('sentences', -1));
        el.sentences.nextBtn.addEventListener('click', () => handlers.navigate('sentences', 1));
        el.sentences.startBtn.addEventListener('click', handlers.startChallenge);

        const data = await api.fetchJSON('/api/cvc-words/');
        if (data && Array.isArray(data.words)) {
            state.words = data.words;

            if (state.words.length > 0) {
                state.currentWordIndex = 0;
                ui.renderCard('words');
            } else {
                el.words.container.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
            }
        }
    })();
});
</script>
{% endblock %}
